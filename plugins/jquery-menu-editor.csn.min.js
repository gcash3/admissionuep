function MenuEditor(idSelector,options){var $main=$("#"+idSelector),settings={labelEdit:'<i class="glyphicon glyphicon-edit clickable"></i>',labelRemove:'<i class="glyphicon glyphicon-remove clickable"></i>',textConfirmDelete:"This item will be deleted. Are you sure?",iconPicker:{cols:5,footer:!1},listOptions:{hintCss:{border:"1px dashed #13981D"},opener:{as:"html",close:'<i class="fa fa-minus"></i>',open:'<i class="fa fa-plus"></i>',openerCss:{"margin-right":"10px"},openerClass:"btn btn-success btn-xs"},placeholderCss:{"background-color":"gray"}}};$.extend(!0,settings,options);var itemEditing=null,sortableReady=!0,$form=null,$updateButton=null,iconPickerOpt=settings.iconPicker,options=settings.listOptions,iconPicker=$("#"+idSelector+"_icon").iconpicker(iconPickerOpt);function editItem($item){var data=$item.data();function extractIcon(icon){var a=icon.split(" ");return 1===a.length?a[0]:2===a.length?a[1]:"empty"}$.each(data,(function(p,v){$form.find("[name="+p+"]").val(v)})),$form.find(".item-menu").first().focus(),data.hasOwnProperty("icon")&&iconPicker.iconpicker("setIcon",extractIcon(data.icon)),$updateButton.removeAttr("disabled")}function resetForm(){$form[0].reset(),(iconPicker=iconPicker.iconpicker(iconPickerOpt)).iconpicker("setIcon","empty"),$updateButton.attr("disabled",!0),itemEditing=null}function stringToArray(str){try{var obj=JSON.parse(str)}catch(err){return console.log("The string is not a json valid."),null}return obj}function TButton(attr){return $("<a>").addClass(attr.classCss).addClass("clickable").attr("href","#").html(attr.text)}function TButtonGroup(){var $divbtn=$("<div>").addClass("btn-group pull-right"),$btnEdit=TButton({classCss:"btn btn-primary btn-xs btnEdit",text:settings.labelEdit}),$btnRemv=TButton({classCss:"btn btn-danger btn-xs btnRemove",text:settings.labelRemove}),$btnUp=TButton({classCss:"btn btn-default btn-xs btnUp btnMove",text:'<i class="fa fa-chevron-up clickable"></i>'}),$btnDown=TButton({classCss:"btn btn-default btn-xs btnDown btnMove",text:'<i class="fa fa-chevron-down clickable"></i>'}),$btnOut=TButton({classCss:"btn btn-default btn-xs btnOut btnMove",text:'<i class="fa fa-chevron-left clickable"></i>'}),$btnIn=TButton({classCss:"btn btn-default btn-xs btnIn btnMove",text:'<i class="fa fa-chevron-right clickable"></i>'}),$btnEdit2=TButton({classCss:"btn btn-default btn-xs btnEdit",text:'<i class="fa fa-pencil clickable"></i>'});return $divbtn.append($btnEdit2).append($btnUp).append($btnDown).append($btnIn).append($btnOut).append($btnEdit).append($btnRemv),$divbtn}function createMenu(arrayItem,depth){var level=void 0===depth?0:depth,$elem=0===level?$main:$("<ul>");return $.each(arrayItem,(function(k,v){var isParent=void 0!==v.children&&$.isArray(v.children),itemObject={text:"",href:"",icon:"empty",target:"_self",title:""},temp=$.extend({},v);isParent&&delete temp.children,$.extend(itemObject,temp);var $li=$("<li>").addClass("list-group-item");$li.data(itemObject);var $div=$("<div>").css("margin-bottom","5px"),$i=$("<i>").addClass(v.icon),$span=$("<span>").addClass("txt").append(v.text),$divbtn=TButtonGroup();$div.append($i).append("&nbsp;").append($span).append($divbtn),$li.append($div),isParent&&$li.append(createMenu(v.children,level+1)),$elem.append($li)})),$elem}function TOpener(li){var opener;$("<span>").addClass("sortableListsOpener "+options.opener.openerClass).css(options.opener.openerCss).on("mousedown",(function(e){var li=$(this).closest("li");return li.hasClass("sortableListsClosed")?li.iconOpen(options):li.iconClose(options),!1})).prependTo(li.children("div").first()),li.hasClass("sortableListsOpen")?li.iconOpen(options):li.iconClose(options)}function setOpeners(){$main.find("li").each((function(){var $li=$(this);$li.children("ul").length&&TOpener($li)}))}$main.sortableLists(settings.listOptions),iconPicker.on("change",(function(e){var iconClass=""!==e.iconClass?e.iconClass+" ":"";$form.find("[name=icon]").val(iconClass+e.icon)})),$(document).on("click",".btnRemove",(function(e){if(e.preventDefault(),confirm(settings.textConfirmDelete)){var list=$(this).closest("ul");$(this).closest("li").remove();var isMainContainer=!1;void 0!==list.attr("id")&&(isMainContainer=list.attr("id").toString()===idSelector),list.children().length||isMainContainer||(list.prev("div").children(".sortableListsOpener").first().remove(),list.remove()),MenuEditor.updateButtons($main)}})),$(document).on("click",".btnEdit",(function(e){e.preventDefault(),editItem(itemEditing=$(this).closest("li"))})),$main.on("click",".btnUp",(function(e){e.preventDefault();var $li=$(this).closest("li");$li.prev("li").before($li),MenuEditor.updateButtons($main)})),$main.on("click",".btnDown",(function(e){e.preventDefault();var $li=$(this).closest("li");$li.next("li").after($li),MenuEditor.updateButtons($main)})),$main.on("click",".btnOut",(function(e){e.preventDefault();var list=$(this).closest("ul"),$li=$(this).closest("li"),$liParent;$li.closest("ul").closest("li").after($li),list.children().length<=0&&(list.prev("div").children(".sortableListsOpener").first().remove(),list.remove()),MenuEditor.updateButtons($main)})),$main.on("click",".btnIn",(function(e){e.preventDefault();var $li=$(this).closest("li"),$prev=$li.prev("li"),$ul;if($prev.length>0)if(($ul=$prev.children("ul")).length>0)$ul.append($li);else{var $ul=$("<ul>");$prev.append($ul),$ul.append($li),$prev.addClass("sortableListsOpen"),TOpener($prev)}MenuEditor.updateButtons($main)})),this.setForm=function(form){$form=form},this.getForm=function(){return $form},this.setUpdateButton=function($btn){($updateButton=$btn).attr("disabled",!0),itemEditing=null},this.getUpdateButton=function(){return $updateButton},this.getCurrentItem=function(){return itemEditing},this.update=function(){var $cEl=this.getCurrentItem();if(null!==$cEl){var oldIcon=$cEl.data("icon");$form.find(".item-menu").each((function(){$cEl.data($(this).attr("name"),$(this).val())})),$cEl.children().children("i").removeClass(oldIcon).addClass($cEl.data("icon")),$cEl.find("span.txt").first().text($cEl.data("text")),resetForm()}},this.add=function(){var data={};$form.find(".item-menu").each((function(){data[$(this).attr("name")]=$(this).val()}));var btnGroup=TButtonGroup(),textItem=$("<span>").addClass("txt").text(data.text),iconItem=$("<i>").addClass(data.icon),div=$("<div>").append(iconItem).append("&nbsp;").append(textItem).append(btnGroup),$li=$("<li>").data(data);$li.addClass("list-group-item").append(div),$main.append($li),MenuEditor.updateButtons($main),resetForm()},this.getString=function(){var obj=$main.sortableListsToJson();return JSON.stringify(obj)},this.setData=function(strJson){var arrayItem=Array.isArray(strJson)?strJson:stringToArray(strJson);if(null!==arrayItem){$main.empty();var menu=createMenu(arrayItem);sortableReady?setOpeners():(menu.sortableLists(settings.listOptions),sortableReady=!0),MenuEditor.updateButtons($main)}}}!function($){$.fn.sortableLists=function(options){var containerNL=this,jQBody=$("body").css("position","relative"),defaults={currElClass:"",placeholderClass:"",placeholderCss:{position:"relative",padding:0},hintClass:"",hintCss:{display:"none",position:"relative",padding:0},hintWrapperClass:"",hintWrapperCss:{},baseClass:"",baseCss:{position:"absolute",top:0-parseInt(jQBody.css("margin-top")),left:0-parseInt(jQBody.css("margin-left")),margin:0,padding:0,"z-index":2500},opener:{active:!0,as:"html",open:"",close:"",openerCss:{float:"left",display:"inline-block","background-position":"center center","background-repeat":"no-repeat"},openerClass:""},listSelector:"ul",listsClass:"",listsCss:{},insertZone:50,insertZonePlus:!1,scroll:20,ignoreClass:"clickable",isAllowed:function(cEl,hint,target){return!0},onDragStart:function(e,cEl){return!0},onChange:function(cEl){return!0},complete:function(cEl){return MenuEditor.updateButtons(containerNL),!0}},setting=$.extend(!0,{},defaults,options),base=$("<"+setting.listSelector+" />").prependTo(jQBody).attr("id","sortableListsBase").css(setting.baseCss).addClass(setting.listsClass+" "+setting.baseClass),placeholder=$("<li />").attr("id","sortableListsPlaceholder").css(setting.placeholderCss).addClass(setting.placeholderClass),hint=$("<li />").attr("id","sortableListsHint").css(setting.hintCss).addClass(setting.hintClass),hintWrapper=$("<"+setting.listSelector+" />").attr("id","sortableListsHintWrapper").addClass(setting.listsClass+" "+setting.hintWrapperClass).css(setting.listsCss).css(setting.hintWrapperCss),opener=$("<span />").addClass("sortableListsOpener "+setting.opener.openerClass).css(setting.opener.openerCss).on("mousedown",(function(e){var li=$(this).closest("li");return li.hasClass("sortableListsClosed")?li.iconOpen(setting):li.iconClose(setting),!1}));"class"===setting.opener.as?opener.addClass(setting.opener.close):"html"===setting.opener.as&&opener.html(setting.opener.close);var state={isDragged:!1,isRelEFP:null,oEl:null,rootEl:null,cEl:null,upScroll:!1,downScroll:!1,pX:0,pY:0,cX:0,cY:0,isAllowed:!0,e:{pageX:0,pageY:0,clientX:0,clientY:0},doc:$(document),win:$(window)};if(setting.opener.active){if(!setting.opener.open)throw"Opener.open value is not defined. It should be valid url, html or css class.";if(!setting.opener.close)throw"Opener.close value is not defined. It should be valid url, html or css class.";$(this).find("li").each((function(){var li=$(this);li.children(setting.listSelector).length&&(opener.clone(!0).prependTo(li.children("div").first()),li.hasClass("sortableListsOpen")?li.iconOpen(setting):li.iconClose(setting))}))}return this.on("mousedown",(function(e){var target=$(e.target);if(!(!1!==state.isDragged||setting.ignoreClass&&target.hasClass(setting.ignoreClass))){e.preventDefault();var el=target.closest("li"),rEl=$(this);el[0]&&(setting.onDragStart(e,el),startDrag(e,el,rEl))}}));function startDrag(e,el,rEl){state.isDragged=!0;var elMT=parseInt(el.css("margin-top")),elMB=parseInt(el.css("margin-bottom")),elML=parseInt(el.css("margin-left")),elMR=parseInt(el.css("margin-right")),elXY=el.offset(),elIH=el.innerHeight();state.rootEl={el:rEl,offset:rEl.offset(),rootElClass:rEl.attr("class")},state.cEl={el:el,mT:elMT,mL:elML,mB:elMB,mR:elMR,offset:elXY},state.cEl.xyOffsetDiff={X:e.pageX-state.cEl.offset.left,Y:e.pageY-state.cEl.offset.top},state.cEl.el.addClass("sortableListsCurrent "+setting.currElClass),el.before(placeholder);var placeholderNode=state.placeholderNode=$("#sortableListsPlaceholder");el.css({width:el.width(),position:"absolute",top:elXY.top-$(window).scrollTop()-elMT,left:elXY.left-$(window).scrollLeft()-elML}).prependTo(base),placeholderNode.css({display:"block",height:elIH}),hint.css("height",elIH),state.doc.on("mousemove",dragging).on("mouseup",endDrag)}function dragging(e){if(state.isDragged){var cEl=state.cEl,doc=state.doc,win=state.win;e.pageX||setEventPos(e),doc.scrollTop()>state.rootEl.offset.top-10&&e.clientY<50?state.upScroll?(e.pageY=e.pageY-setting.scroll,$("html, body").each((function(i){$(this).scrollTop($(this).scrollTop()-setting.scroll)})),setCursorPos(e)):setScrollUp(e):doc.scrollTop()+win.height()<state.rootEl.offset.top+state.rootEl.el.outerHeight(!1)+10&&win.height()-e.clientY<50?state.downScroll?(e.pageY=e.pageY+setting.scroll,$("html, body").each((function(i){$(this).scrollTop($(this).scrollTop()+setting.scroll)})),setCursorPos(e)):setScrollDown(e):scrollStop(state),state.oElOld=state.oEl,cEl.el[0].style.visibility="hidden",state.oEl=oEl=elFromPoint(e.pageX,e.pageY),cEl.el[0].style.visibility="visible",showHint(e,state),setCElPos(e,state)}}function endDrag(e){var cEl=state.cEl,hintNode=$("#sortableListsHint",state.rootEl.el),hintStyle=hint[0].style,targetEl=null,isHintTarget=!1,hintWrapperNode=$("#sortableListsHintWrapper");"block"===hintStyle.display&&hintNode.length&&state.isAllowed?(targetEl=hintNode,isHintTarget=!0):(targetEl=state.placeholderNode,isHintTarget=!1),offset=targetEl.offset(),cEl.el.animate({left:offset.left-$(window).scrollLeft()-state.cEl.mL,top:offset.top-$(window).scrollTop()-state.cEl.mT},250,(function(){tidyCurrEl(cEl),targetEl.after(cEl.el[0]),targetEl[0].style.display="none",hintStyle.display="none",hintNode.remove(),hintWrapperNode.removeAttr("id").removeClass(setting.hintWrapperClass),hintWrapperNode.length&&hintWrapperNode.prev("div").append(opener.clone(!0)),isHintTarget?state.placeholderNode.slideUp(150,(function(){state.placeholderNode.remove(),tidyEmptyLists(),setting.onChange(cEl.el),setting.complete(cEl.el),state.isDragged=!1})):(state.placeholderNode.remove(),tidyEmptyLists(),setting.complete(cEl.el),state.isDragged=!1)})),scrollStop(state),state.doc.unbind("mousemove",dragging).unbind("mouseup",endDrag)}function setScrollUp(e){state.upScroll||(state.upScroll=setInterval((function(){state.doc.trigger("mousemove")}),50))}function setScrollDown(e){state.downScroll||(state.downScroll=setInterval((function(){state.doc.trigger("mousemove")}),50))}function setCursorPos(e){state.pY=e.pageY,state.pX=e.pageX,state.cY=e.clientY,state.cX=e.clientX}function setEventPos(e){e.pageY=state.pY,e.pageX=state.pX,e.clientY=state.cY,e.clientX=state.cX}function scrollStop(state){clearInterval(state.upScroll),clearInterval(state.downScroll),state.upScroll=state.downScroll=!1}function setCElPos(e,state){var cEl=state.cEl;cEl.el.css({position:"fixed",top:e.clientY-cEl.xyOffsetDiff.Y-cEl.mT,left:e.clientX-cEl.xyOffsetDiff.X-cEl.mL})}function elFromPoint(x,y){if(!document.elementFromPoint)return null;var isRelEFP=state.isRelEFP,s,res;null===isRelEFP&&((s=state.doc.scrollTop())>0&&(isRelEFP=null==(res=document.elementFromPoint(0,s+$(window).height()-1))||"HTML"===res.tagName.toUpperCase()),(s=state.doc.scrollLeft())>0&&(isRelEFP=null==(res=document.elementFromPoint(s+$(window).width()-1,0))||"HTML"===res.tagName.toUpperCase()));isRelEFP&&(x-=state.doc.scrollLeft(),y-=state.doc.scrollTop());var el=$(document.elementFromPoint(x,y));return state.rootEl.el.find(el).length?el.is("#sortableListsPlaceholder")||el.is("#sortableListsHint")?null:el.is("li")?el.is("li")?el:void 0:(el=el.closest("li"))[0]?el:null:null}function showHint(e,state){var oEl=state.oEl;if(oEl&&state.oElOld){var oElH=oEl.outerHeight(!1),relY=e.pageY-oEl.offset().top;setting.insertZonePlus?14>relY?showOnTopPlus(e,oEl,7>relY):oElH-14<relY&&showOnBottomPlus(e,oEl,oElH-7<relY):5>relY?showOnTop(e,oEl):oElH-5<relY&&showOnBottom(e,oEl)}}function showOnTop(e,oEl){if($("#sortableListsHintWrapper",state.rootEl.el).length&&hint.unwrap(),e.pageX-oEl.offset().left<setting.insertZone){if(oEl.prev("#sortableListsPlaceholder").length)return void hint.css("display","none");oEl.before(hint)}else{var children=oEl.children(),list=oEl.children(setting.listSelector).first();if(list.children().first().is("#sortableListsPlaceholder"))return void hint.css("display","none");list.length?list.prepend(hint):(children.first().after(hint),hint.wrap(hintWrapper)),state.oEl&&oEl.iconOpen(setting)}hint.css("display","block"),state.isAllowed=setting.isAllowed(state.cEl.el,hint,hint.parents("li").first())}function showOnTopPlus(e,oEl,outside){if($("#sortableListsHintWrapper",state.rootEl.el).length&&hint.unwrap(),!outside&&e.pageX-oEl.offset().left>setting.insertZone){var children=oEl.children(),list=oEl.children(setting.listSelector).first();if(list.children().first().is("#sortableListsPlaceholder"))return void hint.css("display","none");list.length?list.prepend(hint):(children.first().after(hint),hint.wrap(hintWrapper)),state.oEl&&oEl.iconOpen(setting)}else{if(oEl.prev("#sortableListsPlaceholder").length)return void hint.css("display","none");oEl.before(hint)}hint.css("display","block"),state.isAllowed=setting.isAllowed(state.cEl.el,hint,hint.parents("li").first())}function showOnBottom(e,oEl){if($("#sortableListsHintWrapper",state.rootEl.el).length&&hint.unwrap(),e.pageX-oEl.offset().left<setting.insertZone){if(oEl.next("#sortableListsPlaceholder").length)return void hint.css("display","none");oEl.after(hint)}else{var children=oEl.children(),list=oEl.children(setting.listSelector).last();if(list.children().last().is("#sortableListsPlaceholder"))return void hint.css("display","none");list.length?children.last().append(hint):(oEl.append(hint),hint.wrap(hintWrapper)),state.oEl&&oEl.iconOpen(setting)}hint.css("display","block"),state.isAllowed=setting.isAllowed(state.cEl.el,hint,hint.parents("li").first())}function showOnBottomPlus(e,oEl,outside){if($("#sortableListsHintWrapper",state.rootEl.el).length&&hint.unwrap(),!outside&&e.pageX-oEl.offset().left>setting.insertZone){var children=oEl.children(),list=oEl.children(setting.listSelector).last();if(list.children().last().is("#sortableListsPlaceholder"))return void hint.css("display","none");list.length?children.last().append(hint):(oEl.append(hint),hint.wrap(hintWrapper)),state.oEl&&oEl.iconOpen(setting)}else{if(oEl.next("#sortableListsPlaceholder").length)return void hint.css("display","none");oEl.after(hint)}hint.css("display","block"),state.isAllowed=setting.isAllowed(state.cEl.el,hint,hint.parents("li").first())}function tidyCurrEl(cEl){var cElStyle=cEl.el[0].style;cEl.el.removeClass(setting.currElClass+" sortableListsCurrent"),cElStyle.top="0",cElStyle.left="0",cElStyle.position="relative",cElStyle.width="auto"}function tidyEmptyLists(){$(setting.listSelector,state.rootEl.el).each((function(i){$(this).children().length||($(this).prev("div").children(".sortableListsOpener").first().remove(),$(this).remove())}))}},$.fn.iconOpen=function(setting){this.removeClass("sortableListsClosed").addClass("sortableListsOpen"),this.children("ul").css("display","block");var opener=this.children("div").children(".sortableListsOpener").first();"html"===setting.opener.as?opener.html(setting.opener.close):"class"===setting.opener.as&&opener.addClass(setting.opener.close).removeClass(setting.opener.open)},$.fn.iconClose=function(setting){this.removeClass("sortableListsOpen").addClass("sortableListsClosed"),this.children("ul").css("display","none");var opener=this.children("div").children(".sortableListsOpener").first();"html"===setting.opener.as?opener.html(setting.opener.open):"class"===setting.opener.as&&opener.addClass(setting.opener.open).removeClass(setting.opener.close)},$.fn.sortableListsToJson=function(){var arr=[];return $(this).children("li").each((function(){var li=$(this),object=li.data();arr.push(object);var ch=li.children("ul,ol").sortableListsToJson();ch.length>0?object.children=ch:delete object.children})),arr},$.fn.updateButtons=function(depth){var level=void 0===depth?0:depth,removefirst=["Up","In"],removelast=["Down"];0===level&&(removefirst.push("Out"),removelast.push("Out"),$(this).children("li").hideButtons(["Out"])),$(this).children("li").each((function(){var $li,$ul=$(this).children("ul");$ul.length>0&&$ul.updateButtons(level+1)})),$(this).children("li:first").hideButtons(removefirst),$(this).children("li:last").hideButtons(removelast)},$.fn.hideButtons=function(buttons){for(var i=0;i<buttons.length;i++)$(this).find(".btn-group:first").children(".btn"+buttons[i]).hide()}}(jQuery),MenuEditor.updateButtons=function($mainList){$mainList.find(".btnMove").show(),$mainList.updateButtons()};